var amtToPaidPPP;
var objValue=0;
function fetchPmtPlanDtlFromAckNo(obj){
	//var value = obj.value;
	var taxPayerId = document.getElementById("hidTaxPayerId").value;
	//alert('taxPayerId:'+taxPayerId)
	var ackNo = document.getElementById("txtAckNumber").value;

	FetchPmtPlanDtlFromAckNo.fetchPmtPlanDtlFromAckNo(taxPayerId,ackNo,{async:false,callback:function(data)
		{
		if(data != null)
		{
			var paymentPlanList = data;	
			if(paymentPlanList[0].isDataAvailable==N_FLAG && paymentPlanList[0].isAgent==NO_CALL_MADE)
			{
				alert(errFetchingData);
				onClickInstallmentType();
			}
			else if(paymentPlanList[0].isDataAvailable==N_FLAG && paymentPlanList[0].isAgent==NO_DETAILS_FOUND)
			{
				alert(paidInstallOrPPP);
				onClickInstallmentType();
			}
			else
			{
				var cntr = 0;
				var tabObj = document.getElementById("pppDetails");

				for(var l = tabObj.rows.length; l >1 ;l--)
				{
					tabObj.deleteRow(l -1);
				}
				for(var i=0;i<paymentPlanList.length;i++)
				{
					cntr = parseInt(cntr);
					var tabRow = tabObj.insertRow(tabObj.rows.length);
					tabRow.id="pppDetails_"+cntr;
					var tabCell = new Array();
					for (var j=0;j<7;j++)
					{
						tabCell[j] = tabRow.insertCell(j);
					}
					var paymentPlanDetailDTO = paymentPlanList[i];
					//	paymentDetailDTOArr[i] = paymentDetailDTO;

					document.getElementById("hidObligationId").value = paymentPlanDetailDTO.obligationId;

					for (var allMapKey in AllObligationsMap)
					{
						if(document.getElementById("hidObligationId").value == allMapKey)
						{
							document.getElementById("txtobligationId").value = AllObligationsMap[allMapKey];
						}
					}
					
					var element = document.createElement('input');       
			 		element.type ='radio';
			 		element.name = 'liabilityRadio';
			 		element.id = 'pppRadio_'+cntr;
			 		element.value=cntr;     
			 		element.onclick = function () {addRowHid(this);};
			 		tabCell[0].appendChild(element);
			 		
					if(paymentPlanDetailDTO.installmentStatus=="Paid")
					{
						document.getElementById('pppRadio_'+cntr).disabled=true;	
					}

					tabCell[1].innerHTML =paymentPlanDetailDTO.installmentNo ;
					tabCell[1].style.textAlign="center";
					tabCell[1].style.fontSize="11";


					tabCell[2].innerHTML = paymentPlanDetailDTO.dueDate;
					tabCell[2].style.textAlign="center";
					tabCell[2].style.fontSize="11";

					tabCell[3].innerHTML = convertToKenyanShillingFormatValWithDecimal(paymentPlanDetailDTO.installmentAmount,true);;
					tabCell[3].style.textAlign="center";
					tabCell[3].style.fontSize="11";

					tabCell[4].innerHTML = paymentPlanDetailDTO.installmentStatus;
					tabCell[4].style.textAlign="center";
					tabCell[4].style.fontSize="11";

					var element = document.createElement('input');
					element.type = 'hidden';
					element.value =  paymentPlanDetailDTO.paymentPlanHdrID;
					element.width = "0%";
					tabCell[5].appendChild(element);
					tabCell[5].style.display = "none";

					var element = document.createElement('input');
					element.type = 'hidden';
					element.value =  paymentPlanDetailDTO.paymentPlanInstallmentHdrID;
					element.width = "0%";
					tabCell[6].appendChild(element);
					tabCell[6].style.display = "none";
					cntr = cntr+1;
				}
			}
		}
		else
		{
			alert(errFetchingData);
			onClickInstallmentType();
		}
		}});	
}

function addRowHid(obj)
{

	var id=obj.value;
	var tabObj=document.getElementById('pppDetails');
	id=parseInt(id,10)+parseInt(1,10);
	var rowNum = obj.value;
	objValue=obj.value;
	var rowRef = document.getElementById("pppDetails_" + rowNum);
	var installmentNo;
	var dueDate;
	var installmentAmount;
	if(document.all)
	{
		installmentNo=tabObj.rows[id].cells[1].innerText;
		dueDate=tabObj.rows[id].cells[2].innerText;
		installmentAmount=tabObj.rows[id].cells[3].innerText;
		document.getElementById('in_pppaddDetailTable_6').value=rowRef.getElementsByTagName("INPUT")[1].value;
		document.getElementById('in_pppaddDetailTable_7').value=rowRef.getElementsByTagName("INPUT")[2].value;
	}
	else
	{
		installmentNo=tabObj.rows[id].cells[1].textContent;
		dueDate=tabObj.rows[id].cells[2].textContent;
		installmentAmount=tabObj.rows[id].cells[3].textContent;
		document.getElementById('in_pppaddDetailTable_6').value=rowRef.getElementsByTagName("INPUT")[1].value;
		document.getElementById('in_pppaddDetailTable_7').value=rowRef.getElementsByTagName("INPUT")[2].value;
	}
	document.getElementById('in_pppaddDetailTable_3').value=installmentNo;
	document.getElementById('in_pppaddDetailTable_4').value=dueDate;
	document.getElementById('in_pppaddDetailTable_5').value=installmentAmount;
	document.getElementById('in_pppaddDetailTable_8').value=objValue;

}

function beforeAddPaymentPlanDetails()
{
	var checkDuplicateFlag = checkAddProperInstallment('pppaddDetailTable');
	if(checkDuplicateFlag==false)
	{
		return false;
	}
	else
	{
		amtToPaidPPP=removeCommaFrmInput(document.getElementById('txtTotalAmountPaidPPP').value);
		var tmpAmt=removeCommaFrmInput(document.getElementById('in_pppaddDetailTable_5').value);
		amtToPaidPPP=convertToKenyanShillingFormatVal(parseInt(tmpAmt,10)+parseInt(amtToPaidPPP,10),true);
	}
}

function afterAddPaymentPlanDetails()
{
	document.getElementById('txtTotalAmountPaidPPP').value=amtToPaidPPP;
	document.getElementById('pppRadio_'+objValue).checked=false;
	selectFlagPPP=selectFlagPPP+1;
}


function fetchInitialInstalmentAmt(obj){
//	var value = obj.value;
	var taxPayerId = document.getElementById("hidTaxPayerId").value;
	//alert('taxPayerId:'+taxPayerId)
	var ackNo = document.getElementById("txtAckNumber").value;

	FetchInitialInstalmentAmt.fetchInitialInstalmentAmt(taxPayerId,ackNo,{async:false,callback:function(data)
		{
		if(data != null)
		{
			var paymentPlanList = data;	
			if(paymentPlanList[0].isDataAvailable==N_FLAG && paymentPlanList[0].isAgent==NO_CALL_MADE)
			{
				alert(errFetchingData);
				onClickInstallmentType();
			}
			else if(paymentPlanList[0].isDataAvailable==N_FLAG && paymentPlanList[0].isAgent==NO_DETAILS_FOUND)
			{
				alert(paidInstallOrNoamt);
				onClickInstallmentType();
			}
			else if(paymentPlanList[0].isValuationReq!=null && paymentPlanList[0].isValuationReq!="")
				{
				alert(paymentPlanList[0].isValuationReq);
				onClickInstallmentType();
				}
			else
			{
				var cntr = 0;
				var tabObj = document.getElementById("pppDetails");

				for(var l = tabObj.rows.length; l >1 ;l--)
				{
					tabObj.deleteRow(l -1);
				}
				for(var i=0;i<paymentPlanList.length;i++)
				{
					cntr = parseInt(cntr);
					var tabRow = tabObj.insertRow(tabObj.rows.length);
					tabRow.id="pppDetails_"+cntr;
					var tabCell = new Array();
					for (var j=0;j<7;j++)
					{
						tabCell[j] = tabRow.insertCell(j);
					}
					var paymentPlanDetailDTO = paymentPlanList[i];
					//	paymentDetailDTOArr[i] = paymentDetailDTO;

					document.getElementById("hidObligationId").value = paymentPlanDetailDTO.obligationId;

					for (var allMapKey in AllObligationsMap)
					{
						if(document.getElementById("hidObligationId").value == allMapKey)
						{
							document.getElementById("txtobligationId").value = AllObligationsMap[allMapKey];
						}
					}
					var element = document.createElement('input');       
			 		element.type ='radio';
			 		element.name = 'liabilityRadio';
			 		element.id = 'pppRadio_'+cntr;
			 		element.value=cntr;     
			 		element.onclick = function () {addRowHid(this);};
			 		tabCell[0].appendChild(element);

					if(paymentPlanDetailDTO.installmentStatus=="Paid")
					{
						document.getElementById('pppRadio_'+cntr).disabled=true;	
					}

					cntr = cntr+1;
					tabCell[1].innerHTML = cntr;
					tabCell[1].style.textAlign="center";
					tabCell[1].style.fontSize="11";

					tabCell[2].innerHTML = paymentPlanDetailDTO.dueDate;
					tabCell[2].style.textAlign="center";
					tabCell[2].style.fontSize="11";

					tabCell[3].innerHTML = paymentPlanDetailDTO.installmentAmount;
					tabCell[3].style.textAlign="center";
					tabCell[3].style.fontSize="11";

					tabCell[4].innerHTML = paymentPlanDetailDTO.installmentStatus;
					tabCell[4].style.textAlign="center";
					tabCell[4].style.fontSize="11";

					var element = document.createElement('input');
					element.type = 'hidden';
					element.value =  paymentPlanDetailDTO.paymentPlanHdrID;
					element.width = "0%";
					tabCell[5].appendChild(element);
					tabCell[5].style.display = "none";

					var element = document.createElement('input');
					element.type = 'hidden';
					
					var id = paymentPlanDetailDTO.paymentPlanInstallmentHdrID != null && 
					paymentPlanDetailDTO.paymentPlanInstallmentHdrID != "null" && 
					paymentPlanDetailDTO.paymentPlanInstallmentHdrID != "" ? paymentPlanDetailDTO.paymentPlanInstallmentHdrID : 0;
					
					element.value =  id;
					element.width = "0%";
					tabCell[6].appendChild(element);
					tabCell[6].style.display = "none";
				}
			}
		}
		}});	
}
/*function installmentTypeChecked()
{
	if(document.getElementById('pmtForPPP1').checked == true)
	{
		fetchInitialInstalmentAmt(document.getElementById('txtAckNumber'));
	}
	else if(document.getElementById('pmtForPPP2').checked == true)
	{
		fetchPmtPlanDtlFromAckNo(document.getElementById('txtAckNumber'));
	}
	else 
	{
		alert("Please select installment type.");
		document.getElementById('txtAckNumber').value="";
	}
}*/

function installmentTypeChecked()
{
	if(document.getElementById('pmtForPPP1').checked == true)
	{
		document.getElementById('pppInstallmentNo').value=0;
		fetchInitialInstalmentAmt(document.getElementById('txtAckNumber'));
	}
	else if(document.getElementById('pmtForPPP2').checked == true)
	{
		document.getElementById('pppInstallmentNo').value=1;
		fetchPmtPlanDtlFromAckNo(document.getElementById('txtAckNumber'));
	}
	else 
	{
		alert(installmentType);
		document.getElementById('txtAckNumber').value="";
	}
}

function onClickInstallmentType()
{
	document.getElementById('txtAckNumber').value="";
	document.getElementById('txtobligationId').value=""; 
	clear_table_data('pppDetails');
}
function checkAddProperInstallment(id)
{

	var tabObj1 = document.getElementById(id);
	var tabObj2 = document.getElementById('pppDetails');
	var selectedRadio=document.getElementById('in_pppaddDetailTable_8').value;
	var selectedInstallmentNo=document.getElementById('in_pppaddDetailTable_3').value;
	if(tabObj1.rows.length==1)
	{
		if(document.all)
		{
			installmentNo=tabObj2.rows[1].cells[1].innerText;
		}
		else
		{
			installmentNo=tabObj2.rows[1].cells[1].textContent;
		}
		if(selectedInstallmentNo>installmentNo)
		{
			alert(payPrevious);
			return false;
		}
		else
		{
			return true;
		}

	}
	else
	{ 	
		var tableDataInstallmentNo;
		for (var i = 1, n = tabObj1.rows.length; i <n; i++) 
		{ 
			var modify;

			if(document.all)
			{
				modify=trim(tabObj1.rows[i].cells[2].innerText);
				tableDataInstallmentNo=trim(tabObj1.rows[i].cells[3].innerHTML,"");

			}
			else
			{
				modify=trim(tabObj1.rows[i].cells[2].textContent,"");
				tableDataInstallmentNo=trim(tabObj1.rows[i].cells[3].innerHTML,"");
			}

			if((trim(document.getElementById('id_temp_'+id+'_'+i+'_1').value))=="Delete" && (modify=="Modify") &&  (tableDataInstallmentNo==selectedInstallmentNo))
			{
				alert(detailsExists);
				return false;
			}

		}
		tableDataInstallmentNo=trim(tabObj1.rows[parseInt(tabObj1.rows.length,10)-parseInt(1,10)].cells[3].innerHTML,"");
		if((parseInt(selectedInstallmentNo,10)-parseInt(tableDataInstallmentNo,10))>1)
		{
			alert(payPrevious);
			return false;
		}
		else
		{
			return true;
		}

	}

}

function addOnClickButton(obj)
{
	resetErrorList();
	if(validateFormFields(PPPJson))
	{
		if( document.getElementById("pppDetails").rows.length==2)
		{
			objValue=0;
		}
		if(document.getElementById('pppRadio_'+objValue).checked==false)
		{
			alert(atleastOneInstallmentDetails);
			return false;
		}
		else
		{
			if(addConfirm('a_pppaddDetailTable'))
			{
				if(document.getElementById('a_pppaddDetailTable').innerHTML!="Modify")
				{
					addrow('pppaddDetailTable', '3', '6','4','validateDeleteRowPPPTable','','N','Y');
				}
			}
		}
	}
	else
	{
		getErrTabToggle('TabView','2');	
		tabview_switch('TabView', '2');
		hideAndShowTable("errorDiv");
		document.getElementById('btnTbl').style.display="none";
	}
}
function beforeDeleteIntopppaddDetailTable()
{
	
}
function afterDeleteIntopppaddDetailTable()
{
	deleteFlagPPP = 1;
}
function validateDeleteRowPPPTable(tab_str, rowno, cols) 
{
	if(deleteFlagPPP==1 )
	{
		var table = document.getElementById('pppaddDetailTable');  
		var	totalAmt = removeCommaFrmInput(document.getElementById('txtTotalAmountPaidPPP').value);
		var tempAmt = table.rows[rowno].cells[5].innerHTML;
		totalAmt = totalAmt - parseInt(removeCommaFrmInput(tempAmt),"10");
		document.getElementById('txtTotalAmountPaidPPP').value =  totalAmt;
		document.getElementById('txtTotalAmountPaidPPP').value = convertToKenyanShillingFormatVal(document.getElementById("txtTotalAmountPaidPPP").value, true);
		selectFlagPPP=selectFlagPPP-1;
		deleteFlagPPP = 0;
	}
	else
	{
		deleteFlagPPP = 0;
	}
}
function clearPPPForm()
{
	var x;
		x = confirm ("Do You want to Clear the Data?");
	if(x)
	{	
		document.getElementById('pmtForPPP1').checked = false;
		document.getElementById('pmtForPPP2').checked = false;
		document.getElementById('txtAckNumber').value =  ''; 
		document.getElementById('txtobligationId').value =  ''; 
		clear_table_data('pppDetails'); 
	}
}
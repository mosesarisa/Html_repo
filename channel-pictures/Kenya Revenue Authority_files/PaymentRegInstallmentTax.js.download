var selectedFlagInstallment=0;
var deleteFlagInstallment = 0;
var modifyFlagInstallment=0;
var amtToPaidInstallment=0;
var TotalAmtToPaidInstallment=0;
var installmentJson={"field":[{"name":"in_installmentTable_5","rule":[{"required":"y","dispName":"Amount Paid","type":"amount"}]}
//Commented - 01/2025 - Allow negative values - Estimated - 81170
                              //{"name":"in_installmentTable_7","rule":[{"required":"n","dispName":"Estimated Tax Value ","type":"amount"}]}
]};
var monthNames = new Array("Jan","Jan", "Feb", "Mar",  "Apr", "May", "Jun", "Jul", "Aug", "Sep",  "Oct", "Nov", "Dec");
function onchangeCmbInstPredBase(obj)
{
	document.getElementById('in_installmentTable_7').value='';
	document.getElementById('in_installmentTable_5').value='';
//Added by ruth and Lawrence on 04/10/2022 Finance Act 2022 Installment Overpayment
	document.getElementById('installmentAmount').value='0';
	document.getElementById('voucherAmount').value='';
	document.getElementById('voucherNo').value='';
	document.getElementById("in_installmentTable_5").setAttribute('readOnly',false);
	//end 04/10/2022
	resetErrorList();
	if(validateFormFields(paymentRegTaxDetailsJson))
	{
		if(validateFormFields(paymentRegTaxPeriodDetailsJson))
		{
			
			var taxPeriod =obj.value;
			var yearIndex = taxPeriod.charAt(0);
			taxPeriod = taxPeriod.substring(1,taxPeriod.length);
			if(yearIndex == "P" || yearIndex =="p")
			{
				var taxPeriodArr = taxPeriod.split("-");
				var frmDate = taxPeriodArr[0];
				var toDate = taxPeriodArr[1];
				FetchObligationDetail.fetchObligationDetail(document.getElementById('hidTaxPayerId').value,document.getElementById('hidObligationId').value,frmDate,toDate,null,function(data) {
					if(data != null)
					{	
						document.getElementById('hidPaymentDetailDTOList').value = data;
						var paymentDetailDtlDTOList = data;
						if(paymentDetailDtlDTOList!= null)
						{	
							document.getElementById('in_installmentTable_7').value =convertToKenyanShillingFormatVal((Math.ceil(paymentDetailDtlDTOList[0].imposedPrincipalAmount)),true); 
							/* Changed by Ombega for ticket ::: START */
							document.getElementById('in_installmentTable_7').readOnly=false;
							/* Changed by Ombega for ticket ::: END */
							
							//document.getElementById('in_installmentTable_7').className='readonlyInput form101_textfcurr_width textonlyRight';
							document.getElementById('hidAccMonthForInst').value=paymentDetailDtlDTOList[0].accMonth;
							document.getElementById('hidIsActiveInAgri').value=paymentDetailDtlDTOList[0].isActive;
							onchangeEstimatedTaxValue();
						}
					}

				});
				
			}
			//changes done for PR#138
			else if(yearIndex == "C" || yearIndex =="c")
			{
				var taxPeriodArr = taxPeriod.split("-");
				var frmDate = taxPeriodArr[0];
				var toDate = taxPeriodArr[1];
				FetchObligationDetail.fetchObligationDetail(document.getElementById('hidTaxPayerId').value,document.getElementById('hidObligationId').value,frmDate,toDate,null,function(data) {
					if(data != null)
					{	
						document.getElementById('hidPaymentDetailDTOList').value = data;
						var paymentDetailDtlDTOList = data;
						if(paymentDetailDtlDTOList!= null)
						{	
							/*document.getElementById('in_installmentTable_7').value =convertToKenyanShillingFormatVal((Math.ceil(paymentDetailDtlDTOList[0].imposedPrincipalAmount)),true); 
							document.getElementById('in_installmentTable_7').readOnly=true;
							document.getElementById('in_installmentTable_7').className='readonlyInput form101_textfcurr_width textonlyRight';*/
							document.getElementById('in_installmentTable_5').value= 0;
							document.getElementById('in_installmentTable_7').value= '';
							document.getElementById('in_installmentTable_7').readOnly=false;
							
							//document.getElementById('in_installmentTable_7').className='form101_textfcurr form101_textfcurr_width textonlyRight';
							document.getElementById('hidAccMonthForInst').value=paymentDetailDtlDTOList[0].accMonth;
							document.getElementById('hidIsActiveInAgri').value=paymentDetailDtlDTOList[0].isActive;
							//onchangeEstimatedTaxValue();
						}
					}

				});
			}
			//end
			else
			{
				document.getElementById('in_installmentTable_5').value= 0;
				document.getElementById('in_installmentTable_7').value= '';
				document.getElementById('in_installmentTable_7').readOnly=false;
				//document.getElementById('in_installmentTable_7').className='form101_textfcurr form101_textfcurr_width textonlyRight';
			}
			//checkForOblig();
			return true;
		}
		else
		{
			document.getElementById('in_installmentTable_13').selectedIndex=0;
			getErrTabToggle('TabView','2');	
			tabview_switch('TabView', '2');
			hideAndShowTable("errorDiv");
			document.getElementById('btnTbl').style.display="none";
			return false;
		}
	}
	else
	{
		document.getElementById('in_installmentTable_13').selectedIndex=0;
		getErrTabToggle('TabView','2');	
		tabview_switch('TabView', '2');
		hideAndShowTable("errorDiv");
		document.getElementById('btnTbl').style.display="none";
		return false;
	}

}

function onchangecmbInstNum(obj){
	/*if( document.getElementById('in_installmentTable_6').selectedIndex == 0){
		alert("Please select valid installment number");
		return false;
	}
	else{
		if(getFistAndNextYearWebForInstallment()){
			return true;
		}
	}*/
}
function getFistAndNextYearWebForInstallment()
{
	/*document.getElementById('in_installmentTable_13').length = 0;

	var oOption = document.createElement("OPTION"); 
	oOption.text="--Select--"; 
	oOption.value="-1"; 
	document.getElementById('in_installmentTable_13').add(oOption); 

	//for previous year value.............
	var previousFromDateText;
	var previousToDateText;
	var taxPeriodArr = document.getElementById('cmbTaxPeriod').options[1].value.split('-');
	var taxPeriodFrom = taxPeriodArr[0];
	var taxPeriodTo = taxPeriodArr[1];

	var dateArr = taxPeriodFrom.split('/');
	var day = dateArr[0];
	var month = dateArr[1];
	var year = dateArr[2];

	var curmonth = parseInt(month,10);
	var curyear = parseInt(year - 1,10);
	var curday = parseInt(day,10);

	previousFromDateText = monthNames[curmonth]+" "+curyear;
	var previousFromDateValue = curday + "/" + curmonth + "/" + curyear;


	dateArr = taxPeriodTo.split('/');
	day = dateArr[0];
	month = dateArr[1];

	year = dateArr[2];
	curmonth = parseInt(month,10);
	curyear = parseInt(year - 1,10);
	curday = parseInt(day,10);

	previousToDateText = monthNames[curmonth]+" "+curyear;
	var previousToDateValue = curday + "/" + curmonth + "/" + curyear;

	var oOption=document.createElement("option");
	optionId='P'+previousFromDateValue+"-"+previousToDateValue;
	optionValue= previousFromDateText +"-"+previousToDateText+' (Previous Year)';
	oOption.text=optionValue;
	oOption.value=optionId;
	oOption.title=optionValue;
	document.getElementById("in_installmentTable_13").add(oOption);
	var oOption=document.createElement("option");
	optionId='C'+document.getElementById('cmbTaxPeriod').options[1].value;
	optionValue=document.getElementById('cmbTaxPeriod').options[1].text+' (Current Year)';
	oOption.text=optionValue;
	oOption.value=optionId;
	oOption.title=optionValue;
	document.getElementById("in_installmentTable_13").add(oOption);
	return true;*/
}
function beforeAddIntoinstallmentTable(row)
{

	var checkDuplicateFlag = checkDuplicateForObligation(row,'installmentTable');
	if(checkDuplicateFlag==false)
	{
		return false;
	}
	else
	{
		document.getElementById('in_installmentTable_12').value = Obligation_Type_Tax;
		var taxPeriod=document.getElementById('cmbTaxPeriod').selectedIndex;
		var taxPeriodValue= document.getElementById('cmbTaxPeriod')[taxPeriod].text;
		document.getElementById('in_installmentTable_4').value = taxPeriodValue;
		document.getElementById('in_installmentTable_14').value=document.getElementById('cmbTaxPeriod').value;
		document.getElementById('in_installmentTable_8').value=document.getElementById('cmbTaxSubHead').value;
		TotalAmtToPaidInstallment=removeCommaFrmInput(document.getElementById('in_installmentTable_5').value);
		var taxTypeIndex = document.getElementById('cmbTaxSubHead').selectedIndex;
		var taxTypeName =  document.getElementById('cmbTaxSubHead')[taxTypeIndex].text;
		document.getElementById('in_installmentTable_3').value = taxTypeName;
	}
}


function afterAddIntoinstallmentTable()
{
	document.getElementById('cmbTaxPeriod').selectedIndex=0;

	document.getElementById('in_installmentTable_6').selectedIndex=0;//inst num
	document.getElementById('in_installmentTable_13').selectedIndex=0;//prediction base

	document.getElementById('in_installmentTable_12').value = Obligation_Type_Tax;
	document.getElementById('in_installmentTable_9').value = 0;
	document.getElementById('in_installmentTable_7').value=0;
	document.getElementById('in_installmentTable_5').value="";
	var tmpAmtToPaid=removeCommaFrmInput(document.getElementById('txtTotalAmountPaidOblig').value);
	document.getElementById('txtTotalAmountPaidOblig').value=convertToKenyanShillingFormatVal(removeCommaFrmInput(parseInt(tmpAmtToPaid,10)+parseInt(TotalAmtToPaidInstallment,10)),true);
	selectedFlagInstallment=selectedFlagInstallment+1;
}


function beforeDeleteIntoinstallmentTable()
{
	if(modifyFlagInstallment==1)
	{
		alert(confirmModifyingOperation);
		return false;
	}
}

function afterDeleteIntoinstallmentTable()
{
	deleteFlagInstallment = 1;
	selectedFlagAdvanceTax = selectedFlagAdvanceTax -1;
}

function validateDeleteRowIntoinstallmentTable(tab_str, rowno, cols) 
{
	if(deleteFlagInstallment==1 && modifyFlagInstallment==0)
	{
		var table = document.getElementById('installmentTable');
		totalAmt = removeCommaFrmInput(document.getElementById('txtTotalAmountPaidOblig').value);
		var tempAmt = table.rows[rowno].cells[5].innerHTML;
		totalAmt =  parseInt(totalAmt,10) - parseInt(removeCommaFrmInput(tempAmt),10);
		document.getElementById('txtTotalAmountPaidOblig').value = convertToKenyanShillingFormatVal(totalAmt, true);
		deleteFlagInstallment = 0;
	}
	else
	{
		deleteFlagInstallment = 0;
	}
}
function beforeModifyIntoinstallmentTable(row) 
{
	if(addInstallment())
	{
		var checkDuplicateFlag = addInstallment(row);
		if(checkDuplicateFlag==false)
		{
			return false;
		}
		else
		{
			var taxPeriod = document.getElementById('cmbTaxPeriod').selectedIndex;
			var taxPeriodYear =document.getElementById('cmbTaxPeriod')[taxPeriod].text;
			document.getElementById('in_advanceTaxTable_4').value=taxPeriodYear;
			document.getElementById('in_installmentTable_14').value=document.getElementById('cmbTaxPeriod').value;
			document.getElementById('in_installmentTable_8').value=document.getElementById('cmbTaxSubHead').value;
			totalAmt=removeCommaFrmInput(document.getElementById('txtTotalAmountPaidOblig').value);
		}
	}
	else
	{
		return false;
	}
}
function afterModifyIntoinstallmentTable() 
{
	modifyFlagInstallment = 0;
	commonModifyFlag=0;
	var table = document.getElementById('installmentTable');  
	var modifyAmt;
	if(document.all)
	{
		modifyAmt=table.rows[rowno].cells[5].innerText;
	}
	else
	{
		modifyAmt=table.rows[rowno].cells[5].textContent;
	}
	totalAmt = parseInt(removeCommaFrmInput(totalAmt),10) + parseInt(removeCommaFrmInput(modifyAmt),10) - parseInt(removeCommaFrmInput(TotalAmtToPaidInstallment),10);
	document.getElementById('txtTotalAmountPaidOblig').value = convertToKenyanShillingFormatVal(totalAmt, true);
	document.getElementById('cmbTaxPeriod').selectedIndex='0';
	/*document.getElementById('cmbTaxPeriodMonth').selectedIndex='0';
	document.getElementById('cmbTaxPeriodMonth').disabled=true;
	document.getElementById('cmbTaxPeriodYear').selectedIndex='0';
	document.getElementById('cmbTaxSubHead').selectedIndex='0';*/
	document.getElementById('in_installmentTable_6').selectedIndex=0;//inst num
	document.getElementById('in_installmentTable_13').selectedIndex=0;//prediction base
	document.getElementById('in_installmentTable_12').value = Obligation_Type_Tax;
	document.getElementById('in_installmentTable_9').value = 0;
	document.getElementById('in_installmentTable_7').value=0;
	document.getElementById('in_installmentTable_5').value="";
	/*document.getElementById('CmbTaxPeriodTd').style.display = 'none';
	document.getElementById('tdCmbTaxPeriod').style.display = 'none';
	document.getElementById('noTaxPeriodTd').style.display = '';
	document.getElementById('noTaxPeriodTd1').style.display = '';*/
}


function validateModifyRowIntoinstallmentTable(tab_str, rowno, cols) 
{
	modifyFlagInstallment=1;
	commonModifyFlag=1;
	document.getElementById('cmbTaxSubHead').value=document.getElementById('in_installmentTable_8').value;
	fetchTaxPeriod();
	TotalAmtToPaidInstallment=removeCommaFrmInput(document.getElementById('in_installmentTable_5').value);
	/*document.getElementById('CmbTaxPeriodTd').style.display = '';
	document.getElementById('tdCmbTaxPeriod').style.display = '';
	document.getElementById('tdCmbTaxPeriodMonth').style.display = 'none';
	document.getElementById('tdCmbTaxPeriodYear').style.display = 'none';
	document.getElementById('CmbTaxPeriodMonthLabelTd').style.display = 'none';
	document.getElementById('CmbTaxPeriodYearLabelTd').style.display = 'none';*/
	document.getElementById('cmbTaxPeriod').value=document.getElementById('in_installmentTable_14').value;
}

function clearInstallmentDetails()
{
	if(clear_table('installmentTable', '12'))
	{
		document.getElementById('cmbTaxPeriod').selectedIndex='0';
		document.getElementById('cmbTaxPeriodMonth').selectedIndex='0';
		document.getElementById('cmbTaxPeriodMonth').disabled=true;
		document.getElementById('cmbTaxPeriodYear').selectedIndex='0';
		document.getElementById('in_installmentTable_6').selectedIndex=0;//inst num
		document.getElementById('in_installmentTable_13').selectedIndex=0;//prediction base
		document.getElementById('cmbTaxSubHead').selectedIndex='0';
		modifyFlagInstallment=0;
		commonModifyFlag=0;
	}
}
function addInstallment(row)
{
	resetErrorList();
	if(validateFormFields(paymentRegTaxHeadJson,paymentRegTaxDetailsJson,paymentRegPmtTtypeJson))
	{
		if(validateFormFields(paymentRegTaxPeriodDetailsJson))
		{
			if(validateFormFields(installmentJson))
			{
				var checkDuplicateFlag = checkDuplicateForObligation(row,'installmentTable');
				if(checkDuplicateFlag==false)
				{
					return false;
				}
				if (document.getElementById('in_installmentTable_5').value<='0')
				{
					alert(paidAmtMoreThanZero);
					return false;
				}
				else
				{
					if(addConfirm('a_installmentTable'))
					{
						if(document.getElementById('a_installmentTable').innerHTML!="Modify")
						{
							addrow('installmentTable', '3', '12','4','validateDeleteRowIntoinstallmentTable','validateModifyRowIntoinstallmentTable','N','N');
						}
						else
						{
							return true;
						}
					}
				}
			}
			else
			{
				document.getElementById('in_installmentTable_13').selectedIndex=0;
				getErrTabToggle('TabView','2');	
				tabview_switch('TabView', '2');
				hideAndShowTable("errorDiv");
				document.getElementById('btnTbl').style.display="none";
				return false;
			}
		}
		else
		{
			document.getElementById('in_installmentTable_13').selectedIndex=0;
			getErrTabToggle('TabView','2');	
			tabview_switch('TabView', '2');
			hideAndShowTable("errorDiv");
			document.getElementById('btnTbl').style.display="none";
			return false;
		}

	}
	else
	{
		document.getElementById('in_installmentTable_13').selectedIndex=0;
		getErrTabToggle('TabView','2');	
		tabview_switch('TabView', '2');
		hideAndShowTable("errorDiv");
		document.getElementById('btnTbl').style.display="none";
		return false;
	}

}


function validateInstallmentDtls(id)
{
	//resetErrorList();
	var rtnFlag = validateFormFieldOnEvent(id, installmentJson);
	getErrTabToggle('TabView','2');
	if(!rtnFlag)
	{
		tabview_switch('TabView', '2');
		hideAndShowTable("errorDiv");
		document.getElementById('btnTbl').style.display="none";
		return rtnFlag;
	}
	else{
		var amtPaid = removeCommaFrmInput(document.getElementById(id).value);
	document.getElementById(id).value = convertToKenyanShillingFormatVal(amtPaid,true);

	if(document.getElementById('cmbTaxHead').value ==  AGENCY_NOTICE || document.getElementById('cmbTaxHead').value ==  AUCTION_NOTICE){
		validateAmountForAgencyAndAuction(amtPaid);
		return true;
	}
	if(document.getElementById('cmbTaxHead').value ==  AGENCY_REVENUE && document.getElementById('cmbTaxSubHead').value ==  stampDutyObligationId){
		var result=convertToKenyanShillingFormatVal(amtPaid,true);
		document.getElementById(id).value = result;
		document.getElementById('txtTotalAmountPayableOTR').value = result;
		return true;
	}else{
		var result=convertToKenyanShillingFormatVal(amtPaid,true);
		document.getElementById(id).value = result;
		return true;
	}

	}
	
}
function onchangeEstimatedTaxValue()
{
	if(removeCommaFrmInput(document.getElementById('in_installmentTable_7').value)>0)
	{
		var percentage = getPercentage();
		var amt= Math.round(parseInt(removeCommaFrmInput(document.getElementById('in_installmentTable_7').value),10)*percentage);
		document.getElementById('in_installmentTable_5').value= convertToKenyanShillingFormatVal(amt,true);
	}
	else if(removeCommaFrmInput(document.getElementById('in_installmentTable_7').value)<0)
	{
		document.getElementById('in_installmentTable_7').value= convertToKenyanShillingFormatVal(0,true);
	}
}

function getPercentage()
{
	var percentage;
	if('N'==document.getElementById('hidIsActiveInAgri').value)
		{
			percentage = 0.25;
		}
	else{
		var accMonth = document.getElementById('hidAccMonthForInst').value;
		var sysDate = document.getElementById('currServerDate').value;
		var sysMonth = sysDate.substring(3,5);
		var checkMonth = (parseInt(accMonth,10) + 9)%12 ;
		if(checkMonth==0) checkMonth=12;
		var arr = new Array();
		// for checking if present month is in the last quarter or not
		arr[0] = (parseInt(checkMonth,10) + 1)%12 ;
		if(arr[0]==0) arr[0]=12;  // if dec, it will take month=12 which was earlier 0
		arr[1] = (parseInt(checkMonth,10) + 2)%12 ;
		if(arr[1]==0) arr[1]=12;
		arr[2] = (parseInt(checkMonth,10) + 3)%12 ;
		if(arr[2]==0) arr[2]=12;
		if(sysMonth==arr[0] || sysMonth==arr[1] || sysMonth==arr[2])
		{
			percentage = 0.25;
		}
		else{
			percentage = 0.75;
		}
	}
	return percentage;
}

//changes done for CR IT Detachment
function checkForOblig(obj)
{
	var obligId=document.getElementById('hidObligationId').value;
	var taxPeriod =obj.value;
	var yearIndex = taxPeriod.charAt(0);
	taxPeriod = taxPeriod.substring(1,taxPeriod.length);
	if(yearIndex == "P" || yearIndex =="p")
	{
		var taxPeriodArr = taxPeriod.split("-");
		var frmDate = taxPeriodArr[0];
		var toDate = taxPeriodArr[1];

		if(obligId==itResident && document.getElementById('in_installmentTable_7').value==0)
		{
			FetchObligationDetail.fetchObligationDetail(document.getElementById('hidTaxPayerId').value,itNonResident,frmDate,toDate,null,function(data) {
				if(data != null)
				{	
					document.getElementById('hidPaymentDetailDTOList').value = data;
					var paymentDetailDtlDTOList = data;
					if(paymentDetailDtlDTOList!= null)
					{	
						document.getElementById('in_installmentTable_7').value =convertToKenyanShillingFormatVal((Math.ceil(paymentDetailDtlDTOList[0].imposedPrincipalAmount)),true); 
						/* Changed by Ombega for ticket 66742 ::: START */
						document.getElementById('in_installmentTable_7').readOnly=false;
						/* Changed by Ombega for ticket 66742 ::: END */
						//document.getElementById('in_installmentTable_7').className='readonlyInput form101_textfcurr_width textonlyRight';
						//document.getElementById('in_installmentTable_7').className=' form101_textfcurr_width textonlyRight';
						document.getElementById('hidAccMonthForInst').value=paymentDetailDtlDTOList[0].accMonth;
						document.getElementById('hidIsActiveInAgri').value=paymentDetailDtlDTOList[0].isActive;
						onchangeEstimatedTaxValue();
					}
				}

			});
		}
		else if(obligId==itNonResident && document.getElementById('in_installmentTable_7').value==0)
		{
			FetchObligationDetail.fetchObligationDetail(document.getElementById('hidTaxPayerId').value,itResident,frmDate,toDate,null,function(data) {
				if(data != null)
				{	
					document.getElementById('hidPaymentDetailDTOList').value = data;
					var paymentDetailDtlDTOList = data;
					if(paymentDetailDtlDTOList!= null)
					{	
						document.getElementById('in_installmentTable_7').value =convertToKenyanShillingFormatVal((Math.ceil(paymentDetailDtlDTOList[0].imposedPrincipalAmount)),true); 
						/* Changed by Ombega for ticket 66742 ::: START */
						document.getElementById('in_installmentTable_7').readOnly=false;
						//document.getElementById('in_installmentTable_7').className='readonlyInput form101_textfcurr_width textonlyRight';
						/* Changed by Ombega for ticket 66742 ::: END */
						document.getElementById('hidAccMonthForInst').value=paymentDetailDtlDTOList[0].accMonth;
						document.getElementById('hidIsActiveInAgri').value=paymentDetailDtlDTOList[0].isActive;
						onchangeEstimatedTaxValue();
					}
				}

			});
		}
	}

	else if(yearIndex == "C" || yearIndex =="c")
	{
		var taxPeriodArr = taxPeriod.split("-");
		var frmDate = taxPeriodArr[0];
		var toDate = taxPeriodArr[1];

		if(obligId==itResident && document.getElementById('in_installmentTable_7').value==0)
		{
			FetchObligationDetail.fetchObligationDetail(document.getElementById('hidTaxPayerId').value,document.getElementById('hidObligationId').value,frmDate,toDate,null,function(data) {
				if(data != null)
				{	
					document.getElementById('hidPaymentDetailDTOList').value = data;
					var paymentDetailDtlDTOList = data;
					if(paymentDetailDtlDTOList!= null)
					{	
						/*document.getElementById('in_installmentTable_7').value =convertToKenyanShillingFormatVal((Math.ceil(paymentDetailDtlDTOList[0].imposedPrincipalAmount)),true); 
					document.getElementById('in_installmentTable_7').readOnly=true;
					document.getElementById('in_installmentTable_7').className='readonlyInput form101_textfcurr_width textonlyRight';*/
						document.getElementById('in_installmentTable_5').value= 0;
						document.getElementById('in_installmentTable_7').value= '';
						document.getElementById('in_installmentTable_7').readOnly=false;
						document.getElementById('in_installmentTable_7').className='form101_textfcurr form101_textfcurr_width textonlyRight';
						document.getElementById('hidAccMonthForInst').value=paymentDetailDtlDTOList[0].accMonth;
						document.getElementById('hidIsActiveInAgri').value=paymentDetailDtlDTOList[0].isActive;
						//onchangeEstimatedTaxValue();
					}
				}

			});
		}

		else if(obligId==itNonResident && document.getElementById('in_installmentTable_7').value==0)
		{
			FetchObligationDetail.fetchObligationDetail(document.getElementById('hidTaxPayerId').value,document.getElementById('hidObligationId').value,frmDate,toDate,null,function(data) {
				if(data != null)
				{	
					document.getElementById('hidPaymentDetailDTOList').value = data;
					var paymentDetailDtlDTOList = data;
					if(paymentDetailDtlDTOList!= null)
					{	
						/*document.getElementById('in_installmentTable_7').value =convertToKenyanShillingFormatVal((Math.ceil(paymentDetailDtlDTOList[0].imposedPrincipalAmount)),true); 
						document.getElementById('in_installmentTable_7').readOnly=true;
						document.getElementById('in_installmentTable_7').className='readonlyInput form101_textfcurr_width textonlyRight';*/
						document.getElementById('in_installmentTable_5').value= 0;
						document.getElementById('in_installmentTable_7').value= '';
						/* Change by Ombega for Ticket 66742 ::: START */
						document.getElementById('in_installmentTable_7').readOnly=false;
						//document.getElementById('in_installmentTable_7').className='form101_textfcurr form101_textfcurr_width textonlyRight';
						/* Change by Ombega for Ticket 66742 ::: END */
						document.getElementById('hidAccMonthForInst').value=paymentDetailDtlDTOList[0].accMonth;
						document.getElementById('hidIsActiveInAgri').value=paymentDetailDtlDTOList[0].isActive;
						//onchangeEstimatedTaxValue();
					}
				}

			});
		}
	}
	/*else if(yearIndex == "C" || yearIndex =="c")
	{
		var taxPeriodArr = taxPeriod.split("-");
		var frmDate = taxPeriodArr[0];
		var toDate = taxPeriodArr[1];

		if(obligId==itResident && document.getElementById('in_installmentTable_7').value==0)
		{
			FetchObligationDetail.fetchObligationDetail(document.getElementById('hidTaxPayerId').value,itNonResident,frmDate,toDate,null,function(data) {
				if(data != null)
				{	
					document.getElementById('hidPaymentDetailDTOList').value = data;
					var paymentDetailDtlDTOList = data;
					if(paymentDetailDtlDTOList!= null)
					{	
						document.getElementById('in_installmentTable_7').value =convertToKenyanShillingFormatVal((Math.ceil(paymentDetailDtlDTOList[0].imposedPrincipalAmount)),true); 
						document.getElementById('in_installmentTable_7').readOnly=true;
						document.getElementById('in_installmentTable_7').className='readonlyInput form101_textfcurr_width textonlyRight';
						document.getElementById('hidAccMonthForInst').value=paymentDetailDtlDTOList[0].accMonth;
						document.getElementById('hidIsActiveInAgri').value=paymentDetailDtlDTOList[0].isActive;
						onchangeEstimatedTaxValue();
					}
				}

			});
		}
		else if(obligId==itNonResident && document.getElementById('in_installmentTable_7').value==0)
		{
			FetchObligationDetail.fetchObligationDetail(document.getElementById('hidTaxPayerId').value,itResident,frmDate,toDate,null,function(data) {
				if(data != null)
				{	
					document.getElementById('hidPaymentDetailDTOList').value = data;
					var paymentDetailDtlDTOList = data;
					if(paymentDetailDtlDTOList!= null)
					{	
						document.getElementById('in_installmentTable_7').value =convertToKenyanShillingFormatVal((Math.ceil(paymentDetailDtlDTOList[0].imposedPrincipalAmount)),true); 
						document.getElementById('in_installmentTable_7').readOnly=true;
						document.getElementById('in_installmentTable_7').className='readonlyInput form101_textfcurr_width textonlyRight';
						document.getElementById('hidAccMonthForInst').value=paymentDetailDtlDTOList[0].accMonth;
						document.getElementById('hidIsActiveInAgri').value=paymentDetailDtlDTOList[0].isActive;
						onchangeEstimatedTaxValue();
					}
				}

			});
		}
	}*/
	
}

//Added by ruth and Lawrence on 04/10/2022 Finance Act 2022 Installment Overpayment
function onchangeFecthIAV(obj){
	var installmentAmount= removeCommaFrmInput(document.getElementById("installmentAmount").value);
	if(installmentAmount==null || installmentAmount<1){
		alert("Enter Installment Amount first");
		document.getElementById("voucherNo").value="";
	}else{
		fetchVarDtls(obj);
	}
	
}
//end 04/10/2022
//Added by ruth and Lawrence on 04/10/2022 Finance Act 2022 Installment Overpayment
function fetchVarDtls(pinObj){
	var voucherNo = $("#"+pinObj.id).val();
	var taxPayerId = document.getElementById('hidTaxPayerId').value;
	if(null!=voucherNo && ''!=voucherNo){
		showProgressbar();
		$.ajax({
	        url: 'paymentRegistration.htm?actionCode=fetchIAV',
	        type: 'post',
	        dataType: 'json',
	        data: {"voucherNo" : voucherNo, "taxPayerId" : taxPayerId },
	        success: function (res) {
	        			if(res.data.voucherAmt!=null){
	        				var voucherAmount=res.data.voucherAmt-res.data.voucherUtilisedAmt;
	        				if(voucherAmount==0){
	        					alert("Voucher number "+voucherNo+" is fully utilised");
	        					//Added on 08/08/2023 Ticket # 64638
	        					document.getElementById("voucherNo").value="";
	        					//End on 08/08/2023 Ticket # 64638
	        				}else{
		        				var installmentAmount= removeCommaFrmInput(document.getElementById("installmentAmount").value);
		        				document.getElementById("voucherAmount").value=convertToKenyanShillingFormatVal(voucherAmount,true);	      
		        				if(installmentAmount>voucherAmount){
		        					//document.getElementById("in_installmentTable_5").value=convertToKenyanShillingFormatVal(installmentAmount-voucherAmount,true);	
		        					alert("The installment amount should be less than or equal to the available voucher amount, '"+voucherAmount+"'.");
		        					document.getElementById("installmentAmount").value=convertToKenyanShillingFormatVal(voucherAmount,true);
		        					document.getElementById("in_installmentTable_5").value=convertToKenyanShillingFormatVal(voucherAmount,true);
		        					document.getElementById("installmentAmount").setAttribute('readOnly',true);
		        				}else {
		        					document.getElementById("in_installmentTable_5").value=convertToKenyanShillingFormatVal(installmentAmount,true); 
		        				}
		        				document.getElementById("in_installmentTable_5").setAttribute('readOnly',true);
	        				}

	        				
	        			}else{
	        				alert("Voucher number "+voucherNo+" is invalid");
	        			}	
	        	hideProgressbar();
	        },
	        error: function (textStatus, errorThrown) {
	        	hideProgressbar();
	        }
	    });
	}

	else{
		
		$('#suppDeclOfMWSupplyForm')[0].reset();
		$("#in_varBasicInfo_5 option[value!='']").remove();
	    alert('Please Enter valid Var PIN');
	}
}
//end 04/10/2022
//Added on 04/10/2022 Finance Act 2022 Installment Overpayment
function onchangeInstallmentPayable(obj){
	var voucherAmount= removeCommaFrmInput(document.getElementById("voucherAmount").value);
	fetchIAVandOAVandRAV()
	var amountPayable=removeCommaFrmInput(obj.value)-voucherAmount;
	if(amountPayable>0){
		var amountTobePaid=removeCommaFrmInput(document.getElementById("in_installmentTable_5").value);
		
		if(amountTobePaid>0 && voucherAmount>0){
			alert("The installment amount should be less than or equal to the available voucher amount, '"+voucherAmount+"'.");
			document.getElementById("installmentAmount").value=convertToKenyanShillingFormatVal(voucherAmount,true);
			document.getElementById("in_installmentTable_5").value=convertToKenyanShillingFormatVal(voucherAmount,true);
			document.getElementById("installmentAmount").setAttribute('readOnly',true);
		}else{
			document.getElementById("in_installmentTable_5").value=convertToKenyanShillingFormatVal(amountPayable,true);	 
		}
	}else {
		document.getElementById("in_installmentTable_5").value=convertToKenyanShillingFormatVal(obj.value,true); 
	}
	document.getElementById("in_installmentTable_5").setAttribute('readOnly',true);
	validateInstallmentDtls(obj.id);
	
}
//end 04/10/2022
//end


//START:::::Added to make IAV/RAV/OAV optional 01/2025
function fetchIAVandOAVandRAV(){
	var taxPayerId = document.getElementById('hidTaxPayerId').value;
		showProgressbar();
		$.ajax({
	        url: 'paymentRegistration.htm?actionCode=fetchIAVandOAVandRAV',
	        type: 'post',
	        dataType: 'json',
	        data: {"taxPayerId" : taxPayerId },
	        success: function (res) {
	        			if(res.data!=0){
	        				alert("You have either IAV/RAV/OAV, You can utilise them!");
	        				}
	        	hideProgressbar();
	        },
	        error: function (textStatus, errorThrown) {
	        	hideProgressbar();
	        }
	    });

}
//END:::::Added to make IAV/RAV/OAV optional 01/2025

